package com.tencent.av.video.effect.core.qqavimage.denoise;

import android.opengl.GLES20;
import com.tencent.av.video.effect.core.qqavimage.QQAVImageFilter;
import com.tencent.av.video.effect.utils.CommonUtils;
import com.tencent.av.video.effect.utils.Log;

public class QQAVImageDenoiseFilter
  extends QQAVImageFilter
{
  public static final String INIT_FRAGMENT_SHADER = " varying highp vec2 textureCoordinate;\n void main()\n {\n      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n }";
  private static final String TAG = "QQAVImageDenoiseFilter";
  private QQAVImageFilter mEmptyFilter = new QQAVImageFilter();
  private boolean mFirstFrameFlag = true;
  private int[] mFrameBufferTextures = new int[3];
  private int[] mFrameBuffers = new int[3];
  private QQAVImageDenoiseGaussianBlurFilter mGaussianBlurFilter = new QQAVImageDenoiseGaussianBlurFilter(1.0F);
  private QQAVImageFilter mInitFilter = new QQAVImageFilter(" varying highp vec2 textureCoordinate;\n void main()\n {\n      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n }");
  private int mLastStoreBlurFbo = -1;
  private int mLastStoreBlurTexture = -1;
  private int mLastStoreFbo = -1;
  private int mLastStoreTexture = -1;
  private QQAVImageDenoiseRGB2YUVFilter mRGB2YUVFilter = new QQAVImageDenoiseRGB2YUVFilter();
  private float mUpdateRate = 0.0F;
  private QQAVImageDenoiseVDCalAndPredFilter mVDCalAndPredFilter = new QQAVImageDenoiseVDCalAndPredFilter();
  private QQAVImageDenoiseYUV2RGBFilter mYUV2RGBFilter = new QQAVImageDenoiseYUV2RGBFilter();
  
  public void onDestroy()
  {
    int[] arrayOfInt = this.mFrameBuffers;
    if (arrayOfInt != null)
    {
      GLES20.glDeleteFramebuffers(arrayOfInt.length, arrayOfInt, 0);
      arrayOfInt = this.mFrameBufferTextures;
      GLES20.glDeleteTextures(arrayOfInt.length, arrayOfInt, 0);
    }
    int i = this.mLastStoreTexture;
    if (i != -1)
    {
      GLES20.glDeleteTextures(2, new int[] { i, this.mLastStoreBlurTexture }, 0);
      GLES20.glDeleteFramebuffers(2, new int[] { this.mLastStoreFbo, this.mLastStoreBlurFbo }, 0);
      this.mLastStoreTexture = -1;
      this.mLastStoreFbo = -1;
      this.mLastStoreBlurTexture = -1;
      this.mLastStoreBlurFbo = -1;
    }
    this.mRGB2YUVFilter.destroy();
    this.mGaussianBlurFilter.destroy();
    this.mVDCalAndPredFilter.destroy();
    this.mYUV2RGBFilter.destroy();
    this.mInitFilter.destroy();
    this.mEmptyFilter.destroy();
    super.onDestroy();
  }
  
  public void onDraw2(int paramInt1, int paramInt2)
  {
    runPendingOnDrawTasks();
    if ((isInitialized()) && (this.mFrameBuffers != null))
    {
      Object localObject = this.mFrameBufferTextures;
      if (localObject == null) {
        return;
      }
      if (this.mFirstFrameFlag)
      {
        this.mFirstFrameFlag = false;
        this.mInitFilter.onDraw2(localObject[0], this.mLastStoreFbo);
        this.mInitFilter.onDraw2(this.mFrameBufferTextures[0], this.mLastStoreBlurFbo);
        Log.d("QQAVImageDenoiseFilter", "init last store");
      }
      this.mRGB2YUVFilter.onDraw2(paramInt1, this.mFrameBuffers[0]);
      this.mGaussianBlurFilter.onDraw2(this.mFrameBufferTextures[0], this.mFrameBuffers[1]);
      localObject = this.mVDCalAndPredFilter;
      int[] arrayOfInt = this.mFrameBufferTextures;
      ((QQAVImageDenoiseVDCalAndPredFilter)localObject).mFilterSourceTexture2 = arrayOfInt[1];
      ((QQAVImageDenoiseVDCalAndPredFilter)localObject).mFilterSourceTexture3 = arrayOfInt[0];
      ((QQAVImageDenoiseVDCalAndPredFilter)localObject).mFilterSourceTexture4 = this.mLastStoreBlurTexture;
      ((QQAVImageDenoiseVDCalAndPredFilter)localObject).onDraw2(this.mLastStoreTexture, this.mFrameBuffers[2]);
      this.mEmptyFilter.onDraw2(this.mFrameBufferTextures[2], this.mLastStoreFbo);
      this.mEmptyFilter.onDraw2(this.mFrameBufferTextures[1], this.mLastStoreBlurFbo);
      localObject = this.mYUV2RGBFilter;
      arrayOfInt = this.mFrameBufferTextures;
      ((QQAVImageDenoiseYUV2RGBFilter)localObject).mFilterSourceTexture2 = arrayOfInt[0];
      ((QQAVImageDenoiseYUV2RGBFilter)localObject).onDraw2(arrayOfInt[2], paramInt2);
    }
  }
  
  public void onInit()
  {
    super.onInit();
    this.mRGB2YUVFilter.onInit();
    this.mGaussianBlurFilter.onInit();
    this.mVDCalAndPredFilter.onInit();
    this.mYUV2RGBFilter.onInit();
    this.mInitFilter.onInit();
    this.mEmptyFilter.onInit();
  }
  
  public void onInitialized()
  {
    super.onInitialized();
    this.mRGB2YUVFilter.onInitialized();
    this.mGaussianBlurFilter.onInitialized();
    this.mVDCalAndPredFilter.onInitialized();
    this.mYUV2RGBFilter.onInitialized();
    this.mInitFilter.onInitialized();
    this.mEmptyFilter.onInitialized();
  }
  
  public void onOutputSizeChanged(int paramInt1, int paramInt2)
  {
    int i;
    if ((this.mOutputWidth == paramInt1) && (this.mOutputHeight == paramInt2)) {
      i = 0;
    } else {
      i = 1;
    }
    super.onOutputSizeChanged(paramInt1, paramInt2);
    if (i != 0)
    {
      int[] arrayOfInt = this.mFrameBuffers;
      if (arrayOfInt != null)
      {
        GLES20.glDeleteFramebuffers(arrayOfInt.length, arrayOfInt, 0);
        arrayOfInt = this.mFrameBufferTextures;
        GLES20.glDeleteTextures(arrayOfInt.length, arrayOfInt, 0);
      }
      this.mRGB2YUVFilter.onOutputSizeChanged(paramInt1, paramInt2);
      this.mGaussianBlurFilter.onOutputSizeChanged(paramInt1, paramInt2);
      this.mVDCalAndPredFilter.onOutputSizeChanged(paramInt1, paramInt2);
      this.mYUV2RGBFilter.onOutputSizeChanged(paramInt1, paramInt2);
      this.mInitFilter.onOutputSizeChanged(paramInt1, paramInt2);
      this.mEmptyFilter.onOutputSizeChanged(paramInt1, paramInt2);
      int j = this.mFrameBufferTextures.length;
      i = 0;
      while (i < j)
      {
        GLES20.glGenFramebuffers(1, this.mFrameBuffers, i);
        GLES20.glGenTextures(1, this.mFrameBufferTextures, i);
        GLES20.glBindTexture(3553, this.mFrameBufferTextures[i]);
        GLES20.glTexImage2D(3553, 0, 6408, paramInt1, paramInt2, 0, 6408, 5121, null);
        GLES20.glTexParameterf(3553, 10240, 9729.0F);
        GLES20.glTexParameterf(3553, 10241, 9729.0F);
        GLES20.glTexParameterf(3553, 10242, 33071.0F);
        GLES20.glTexParameterf(3553, 10243, 33071.0F);
        GLES20.glBindFramebuffer(36160, this.mFrameBuffers[i]);
        GLES20.glFramebufferTexture2D(36160, 36064, 3553, this.mFrameBufferTextures[i], 0);
        GLES20.glBindTexture(3553, 0);
        GLES20.glBindFramebuffer(36160, 0);
        i += 1;
      }
      i = this.mLastStoreTexture;
      if (i != -1)
      {
        GLES20.glDeleteTextures(2, new int[] { i, this.mLastStoreBlurTexture }, 0);
        GLES20.glDeleteFramebuffers(2, new int[] { this.mLastStoreFbo, this.mLastStoreBlurFbo }, 0);
        this.mLastStoreTexture = -1;
        this.mLastStoreFbo = -1;
        this.mLastStoreBlurTexture = -1;
        this.mLastStoreBlurFbo = -1;
      }
      arrayOfInt = new int[2];
      GLES20.glGenTextures(2, arrayOfInt, 0);
      this.mLastStoreTexture = arrayOfInt[0];
      this.mLastStoreFbo = CommonUtils.initFrameBuffer(paramInt1, paramInt2, this.mLastStoreTexture);
      this.mLastStoreBlurTexture = arrayOfInt[1];
      this.mLastStoreBlurFbo = CommonUtils.initFrameBuffer(paramInt1, paramInt2, this.mLastStoreBlurTexture);
      this.mFirstFrameFlag = true;
    }
  }
  
  public void setUpdateRate(float paramFloat)
  {
    float f;
    if (paramFloat > 40.0F)
    {
      f = 40.0F;
    }
    else
    {
      f = paramFloat;
      if (paramFloat < 0.0F) {
        f = 0.0F;
      }
    }
    this.mUpdateRate = f;
    this.mVDCalAndPredFilter.setUpdateRateLocal(f);
  }
}


/* Location:           L:\local\mybackup\temp\qq_apk\com.tencent.mobileqq\classes2.jar
 * Qualified Name:     com.tencent.av.video.effect.core.qqavimage.denoise.QQAVImageDenoiseFilter
 * JD-Core Version:    0.7.0.1
 */